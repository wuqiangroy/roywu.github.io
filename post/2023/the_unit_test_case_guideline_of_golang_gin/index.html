<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>The Unit Test Case Guideline Of Golang Gin | Roy&#39;s Records</title>
<meta name="keywords" content="test, golang, gin">
<meta name="description" content="At this post, I have brief introduced how to test our gin APIs.
And one test case tests one API, maybe this API including thousands functions, this kind of test we allways call Integration Test.
The Integration Test always care whether the API works well or not, it does&rsquo;t care the codes coverage and whether a certain function works as expect or not.
So, we need to write Unit Test to ensure our program robust and keeps the issues number at a very low level.">
<meta name="author" content="wuqiangroy">
<link rel="canonical" href="http://wuqiangroy.github.io/post/2023/the_unit_test_case_guideline_of_golang_gin/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css" integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U&#43;6hYRq/Ez/nm5vg=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://wuqiangroy.github.io/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://wuqiangroy.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://wuqiangroy.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://wuqiangroy.github.io/apple_touch_icon.png">
<link rel="mask-icon" href="https://wuqiangroy.github.io/safari_pinned_tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="The Unit Test Case Guideline Of Golang Gin" />
<meta property="og:description" content="At this post, I have brief introduced how to test our gin APIs.
And one test case tests one API, maybe this API including thousands functions, this kind of test we allways call Integration Test.
The Integration Test always care whether the API works well or not, it does&rsquo;t care the codes coverage and whether a certain function works as expect or not.
So, we need to write Unit Test to ensure our program robust and keeps the issues number at a very low level." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://wuqiangroy.github.io/post/2023/the_unit_test_case_guideline_of_golang_gin/" /><meta property="og:image" content="http://wuqiangroy.github.io/papermod-cover.png"/><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-08-24T23:09:30+08:00" />
<meta property="article:modified_time" content="2023-08-24T23:09:30+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://wuqiangroy.github.io/papermod-cover.png"/>

<meta name="twitter:title" content="The Unit Test Case Guideline Of Golang Gin"/>
<meta name="twitter:description" content="At this post, I have brief introduced how to test our gin APIs.
And one test case tests one API, maybe this API including thousands functions, this kind of test we allways call Integration Test.
The Integration Test always care whether the API works well or not, it does&rsquo;t care the codes coverage and whether a certain function works as expect or not.
So, we need to write Unit Test to ensure our program robust and keeps the issues number at a very low level."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://wuqiangroy.github.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "The Unit Test Case Guideline Of Golang Gin",
      "item": "http://wuqiangroy.github.io/post/2023/the_unit_test_case_guideline_of_golang_gin/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "The Unit Test Case Guideline Of Golang Gin",
  "name": "The Unit Test Case Guideline Of Golang Gin",
  "description": "At this post, I have brief introduced how to test our gin APIs.\nAnd one test case tests one API, maybe this API including thousands functions, this kind of test we allways call Integration Test.\nThe Integration Test always care whether the API works well or not, it does\u0026rsquo;t care the codes coverage and whether a certain function works as expect or not.\nSo, we need to write Unit Test to ensure our program robust and keeps the issues number at a very low level.",
  "keywords": [
    "test", "golang", "gin"
  ],
  "articleBody": "At this post, I have brief introduced how to test our gin APIs.\nAnd one test case tests one API, maybe this API including thousands functions, this kind of test we allways call Integration Test.\nThe Integration Test always care whether the API works well or not, it does’t care the codes coverage and whether a certain function works as expect or not.\nSo, we need to write Unit Test to ensure our program robust and keeps the issues number at a very low level.\nHow to write a unit test for go? It’s very easy for us to write a basic test case in go.\nWe can simply create a file which only subprefix is “_test.go.”, then command go test -v . to execute it.\nHere is an example:\nadd.go\n1 2 3 func Add(a, b int) (c int) { return a + b } And our test file:\nadd_test.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 package main import ( \"testing\" \"github.com/stretchr/testify/assert\" ) func TestAdd(t *testing.T) { var assert = assert.New(t) type S = struct { A int B int C int } var data = []S{ {1, 2, 3}, {-1, -1, -2}, {0, -1, -1}, {999999999999, 1, 1000000000000}, } for _, v := range data { assert.Equal(v.C, Add(v.A, v.B)) } } When I ran go test -run ^TestAdd$ test, and I got:\n=== RUN TestAdd --- PASS: TestAdd (0.00s) PASS ok test 0.307s How to mock function when a function includes multiple calls? using gomonkey to mock common function OK, basic lesson is over, let’s do some a little more deep things.\nConsider a very common situation, we have a function named A. And in function A, it need to call function B, call function C, how should we test A? Like this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 package main func B(a, b string) (result string, err error) { // some logic } func C(a, b string) (result string, err error) { // some logic } func A(a, b string) (score int, err error) { // process the parameters a and b -\u003e a1, b1 result1, err = B(a1, b1) if err != nil { return 0, err } // process result -\u003e a2, b2 result2, err = C(a2, b2) if err != nil { return 0, err } // process the result1 and result2 to got the score return score, nil } In the example above, I have a function A, in A, it will do some very complex logic to process the parameters a and b to get a score.\nI don’t want to care the function B and C due to I have writern unit cases for them and ensure them are run as my expect.\nWe can use a libaray gomonkey to mock the function.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 package main import ( \"testing\" \"github.com/agiledragon/gomonkey/v2\" \"github.com/stretchr/testify/assert\" ) func TestA(t *testing.T) { assert := assert.New(t) var err error mockFunc1 := gomonkey.ApplyFunc(B, func(a, b string) (string, error) { return \"\", nil }) mockFunc2 := gomonkey.ApplyFunc(C, func(a, b string) (string, error) { return \"\", nil }) defer mockFunc1.Reset() defer mockFunc2.Reset() // mocke data then check output, err := A(a, b) assert.NoError(err) assert.Equal(expectData, output) } We can mock function B and C, and output the data what we want.\nAnd the calls in A will not call the real function B and C.\nusing gomonkey to mock function of a struct We can use gomonkey to mock the function of a struct, including public and private\npublic function Here is the example:\nappserver.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 package main type AppServer struct {} func(a *AppServer) A(a, b string) (result string, err error) { // do some logic -\u003e a1, b1 tempResult, err = a.b(a1, b1) if err != nil { return } // process the tempResult // logic return result, nil } func (a *AppServer) b(a, b string) (result string, err error) { // do some logic } var appServer = AppServer{} AppServer has 2 functions: A and b, A is a public function, we can call this function from outer of AppServer, but b is a private function, only call it inner AppServer.\napiserver.go\n1 2 3 4 5 6 7 8 9 10 11 package main func Process(a, b string) (score int, err error) { // process a and b -\u003e a1, b1 result, err = appServer.A(a1, b1) if err != nil { return } // process result -\u003e score return score, nil } Function Process calls public function A of the struct AppServer, how we test Process by mocking function A:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 import ( \"reflect\" \"testing\" \"github.com/agiledragon/gomonkey/v2\" \"github.com/stretchr/testify/assert\" ) func TestProcess(t *testing.T) { var assert = assert.New(t) mockFunc := gomonkey.ApplyMethod(reflect.TypeOf(\u0026appServer), \"A\", func(_ *AppServer, a, b string) (result string, err error) { // mock result return result, nil }) defer mockFunc.Reset() // mock a, b output, err = Process(a, b) assert.NoError(err) assert.Equal(expect, output) } private function If we want to test the function A of AppServer, we can mock the private function b:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 import ( \"reflect\" \"testing\" \"github.com/agiledragon/gomonkey/v2\" \"github.com/stretchr/testify/assert\" ) var testAppServer = AppServer{} func TestProcess(t *testing.T) { var assert = assert.New(t) mockFunc := gomonkey.ApplyPrivateMethod(reflect.TypeOf(\u0026testAppServer), \"b\", func(_ *AppServer, a, b string) (result string, err error) { // mock result return result, nil }) defer mockFunc.Reset() // mock a, b output, err = testAppServer.A(a, b) assert.NoError(err) assert.Equal(expect, output) } How to simulate request parameters? And I will show the full unit test cases of a webserver bases on gin:\napiserver.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 package main import \"github.com/gin-gonic/gin\" type ApiServer struct{} func (a *ApiServer) Query(c *gin.Context) { var err error userName := c.Param(\"userName\") var userInfo = UserInfo{} if userInfo, err = appServer.Query(userName); err != nil { c.JSON(404, []byte(`{\"error\":\"User not found\"}`)) return } c.JSON(200, userInfo) return } func (a *ApiServer) Create(c *gin.Context) { var err error var userInfo UserInfo if err = c.ShouldBindJSON(\u0026userInfo); err != nil { c.JSON(400, []byte(`{\"error\":\"Invalid request body\"}`)) return } if err = appServer.Create(userInfo); err != nil { c.JSON(500, []byte(`{\"error\":\"Failed to create user\"}`)) return } c.JSON(204, nil) return } func (a *ApiServer) QueryUserList(c *gin.Context) { var err error var req = struct { PageSize int `form:\"pageSize\" binding:\"required\"` Page int `form:\"page\" binding:\"required\" ` }{} if err = c.ShouldBind(\u0026req); err != nil { c.JSON(400, []byte(`{\"error\":\"Invalid url value\"}`)) return } var usersInfo []UserInfo if usersInfo, err = appServer.QueryList(req.Page, req.PageSize); err != nil { c.JSON(500, []byte(`{\"error\":\"Failed to query users\"}`)) return } c.JSON(200, usersInfo) return } appserver.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 package main type UserInfo struct { ID string `json:\"id\"` Name string `json:\"name\" binding:\"required\"` Age int `json:\"age\" binding:\"required\"` Email string `json:\"email\" binding:\"required\"` } type AppServer struct{} func (a *AppServer) Query(userName string) (userInfo UserInfo, err error) { // do a database query operation return } func (a *AppServer) Create(userInfo UserInfo) (err error) { // do a database create operation return } func (a *AppServer) QueryList(page, size int) (usersInfo []UserInfo, err error) { // do a database query operation return } var appServer = AppServer{} We assume all the function of AppServer have been tested passed, which means we only need to write the unit test cases for ApiServer.\nWe need to create a universal request function to simulate a real request.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 package main import ( \"io\" \"net/url\" \"net/http\" \"net/http/httptest\" ) func request(function func(c *gin.Context), reqBody []byte, urlParams []gin.Param, urlValues url.Values) (resBody []byte, statusCode int) { w := httptest.NewRecorder() c, _ := gin.CreateTestContext() c.Request = \u0026http.Request{Header: make(http.Header)} // set reqBody c.Request.Body = io.NopCloser(bytes.Newbuffer(reqBody)) // set url value c.Request.URL.RawQuery = urlValues.Encode() // set urlParams for _, param := range urlParams { c.Params = append(c.Params, param) } function(c) body, _ := io.ReadAll(w.Body) return body, w.Code } We noticed that Gin.Context used c.Params = append(c.Params, param) to create the url parameters.\nurl parameters To simulate the url parameters, we can use urlParams := []gin.Param{{Key: \"userName\", Value: \"\"}}. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 func TestQuery(t *testing.T) { var assert = assert.New(t) mockFuncQuery := gomonkey.ApplyMethod(reflect.TypeOf(\u0026appServer), \"Query\", func(_ *AppServer, userName string) (userInfo UserInfo, err error) { if userName == \"\" { return UserInfo{}, errors.New(\"not Found\") } return userInfo{Name: userName}, nil }) defer mockFuncQuery.Reset() var urlParams []gin.Param var body []byte var statusCode int // 404 urlParams = []gin.Param{{Key: \"userName\", Value: \"\"}} body, statusCode = request(testApiServer.Query, nil, urlParams, nil) assert.Equal(404, statusCode) assert.Equal([]byte(`\"error\":\"User not found\"`), body) // 200 urlParams = []gin.Param{{Key: \"userName\", Value: \"Jack\"}} body, statusCode = request(testApiServer.Query, nil, urlParams, nil) assert.Equal(404, statusCode) output := UserInfo{} err := json.Unmarshal(body, \u0026output) assert.NoError(err) assert.Equal(UserInfo{Name: \"Jack\"}, output) } request body The request body is always json string, so we only create a bytes data to simulate it.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 func TestCreate(t *testing.T) { var assert = assert.New(t) var internalError bool mockFuncQuery := gomonkey.ApplyMethod(reflect.TypeOf(\u0026appServer), \"Create\", func(_ *AppServer, userInfo UserInfo) (err error) { if internalError { return errors.New(\"internalError\") } return nil }) defer mockFuncQuery.Reset() var reqBody []byte var body []byte var statusCode int // 400 invalid req body, Name, age and email are must keys. // age type error reqBody = []byte(`{\"name\":\"Jack\",\"Age\":\"12\",\"Email\":\"jack@google.com\"}`) body, statusCode = request(testApiServer.Create, reqBody, nil, nil) assert.Equal(400, statusCode) assert.Equal([]byte(`\"error\":\"Invalid request body\"`), body) // no email field reqBody = []byte(`{\"name\":\"Jack\",\"Age\":12}`) body, statusCode = request(testApiServer.Create, reqBody, nil, nil) assert.Equal(400, statusCode) assert.Equal([]byte(`\"error\":\"Invalid request body\"`), body) // name is empty reqBody = []byte(`{\"name\":\"\",\"Age\":12,\"Email\":\"jack@google.com\"}`) body, statusCode = request(testApiServer.Create, reqBody, nil, nil) assert.Equal(400, statusCode) assert.Equal([]byte(`\"error\":\"Invalid request body\"`), body) // internalError internalError = true reqBody = []byte(`{\"name\":\"Jack\",\"Age\":12,\"Email\":\"jack@google.com\"}`) body, statusCode = request(testApiServer.Create, reqBody, nil, nil) assert.Equal(500, statusCode) assert.Equal([]byte(`\"error\":\"Failed to create user\"`), body) // success -\u003e 204 internalError = false reqBody = []byte(`{\"name\":\"Jack\",\"Age\":12,\"Email\":\"jack@google.com\"}`) _, statusCode = request(testApiServer.Create, reqBody, nil, nil) assert.Equal(204, statusCode) } url value Let’s simulate the url value, the format of url value should be like http://ip:port?page=1\u0026pageSize=10, and the page and pageSize are url values. Here I can use url.Values, and the it provides function Add to add our url valus. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 func TestQueryUserList(t *testing.T) { var assert = assert.New(t) mockFuncQuery := gomonkey.ApplyMethod(reflect.TypeOf(\u0026appServer), \"QueryList\", func(_ *AppServer, page, size int) (usersInfo []UserInfo, err error) { if page \u003c 0 || size \u003c 0 { return nil, errors.New(\"internalError\") } return []UserInfo{{Name: \"Jack\"}}, nil }) defer mockFuncQuery.Reset() var body []byte var statusCode int var urlValues = url.Values{} // no page and no pageSize body, statusCode = request(testApiServer.QueryUserList, nil, nil, urlValues) assert.Equal(400, statusCode) assert.Equal([]byte(`{\"error\":\"Invalid url value\"}`), body) // page \u003c 0 || pageSize \u003c 0 -\u003e internal error urlValues.Add(\"page\", \"-1\") urlValues.Add(\"pageSize\", \"-1\") body, statusCode = request(testApiServer.QueryUserList, nil, nil, urlValues) assert.Equal(500, statusCode) assert.Equal([]byte(`{\"error\":\"Failed to query users\"}`), body) // normal urlValues.Add(\"page\", \"1\") urlValues.Add(\"pageSize\", \"10\") body, statusCode = request(testApiServer.QueryUserList, nil, nil, urlValues) assert.Equal(200, statusCode) var output []UserInfo err := json.Unmarshal(body, \u0026output) assert.NoError(err) assert.ElementsMatch([]UserInfo{{Name: \"Jack\"}}, output) } ",
  "wordCount" : "2054",
  "inLanguage": "en",
  "datePublished": "2023-08-24T23:09:30+08:00",
  "dateModified": "2023-08-24T23:09:30+08:00",
  "author":{
    "@type": "Person",
    "name": "wuqiangroy"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://wuqiangroy.github.io/post/2023/the_unit_test_case_guideline_of_golang_gin/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Roy's Records",
    "logo": {
      "@type": "ImageObject",
      "url": "https://wuqiangroy.github.io/favicon-32x32.png"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://wuqiangroy.github.io/" accesskey="h" title="Roy&#39;s Records (Alt + H)">Roy&#39;s Records</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://wuqiangroy.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://wuqiangroy.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://wuqiangroy.github.io/categories/" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="http://wuqiangroy.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://wuqiangroy.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://wuqiangroy.github.io/">Home</a>&nbsp;»&nbsp;<a href="http://wuqiangroy.github.io/post/">Posts</a></div>
    <h1 class="post-title">
      The Unit Test Case Guideline Of Golang Gin
    </h1>
    <div class="post-meta"><span title='2023-08-24 23:09:30 +0800 CST'>August 24, 2023</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;wuqiangroy

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#how-to-write-a-unit-test-for-go" aria-label="How to write a unit test for go?">How to write a unit test for go?</a></li>
                <li>
                    <a href="#how-to-mock-function-when-a-function-includes-multiple-calls" aria-label="How to mock function when a function includes multiple calls?">How to mock function when a function includes multiple calls?</a><ul>
                        
                <li>
                    <a href="#using-gomonkey-to-mock-common-function" aria-label="using gomonkey to mock common function">using gomonkey to mock common function</a></li>
                <li>
                    <a href="#using-gomonkey-to-mock-function-of-a-struct" aria-label="using gomonkey to mock function of a struct">using gomonkey to mock function of a struct</a></li></ul>
                </li>
                <li>
                    <a href="#how-to-simulate-request-parameters" aria-label="How to simulate request parameters?">How to simulate request parameters?</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>At <a href="">this post</a>, I have brief introduced how to test our gin APIs.<br>
And one test case tests one API, maybe this API including thousands functions, this kind of test we allways call <code>Integration Test</code>.</p>
<p>The <code>Integration Test</code> always care whether the API works well or not, it does&rsquo;t care the codes coverage and whether a certain function works as expect or not.</p>
<p>So, we need to write <code>Unit Test</code> to ensure our program robust and keeps the issues number at a very low level.</p>
<h2 id="how-to-write-a-unit-test-for-go">How to write a unit test for go?<a hidden class="anchor" aria-hidden="true" href="#how-to-write-a-unit-test-for-go">#</a></h2>
<p>It&rsquo;s very easy for us to write a basic test case in go.<br>
We can simply create a file which only subprefix is &ldquo;_test.go.&rdquo;, then command <code>go test -v .</code> to execute it.<br>
Here is an example:<br>
<code>add.go</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Add</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">c</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And our test file:<br>
<code>add_test.go</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;testing&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestAdd</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">assert</span> <span class="p">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">type</span> <span class="nx">S</span> <span class="p">=</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">A</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">        <span class="nx">B</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">        <span class="nx">C</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">data</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">S</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="mi">999999999999</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000000000000</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">data</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">C</span><span class="p">,</span> <span class="nf">Add</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">A</span><span class="p">,</span> <span class="nx">v</span><span class="p">.</span><span class="nx">B</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When I ran <code>go test -run ^TestAdd$ test</code>, and I got:</p>
<pre tabindex="0"><code>=== RUN   TestAdd
--- PASS: TestAdd (0.00s)
PASS
ok      test    0.307s
</code></pre><h2 id="how-to-mock-function-when-a-function-includes-multiple-calls">How to mock function when a function includes multiple calls?<a hidden class="anchor" aria-hidden="true" href="#how-to-mock-function-when-a-function-includes-multiple-calls">#</a></h2>
<h3 id="using-gomonkey-to-mock-common-function">using gomonkey to mock common function<a hidden class="anchor" aria-hidden="true" href="#using-gomonkey-to-mock-common-function">#</a></h3>
<p>OK, basic lesson is over, let&rsquo;s do some a little more deep things.<br>
Consider a very common situation, we have a function named A. And in function A, it need to call function B, call function C, how should we test A?
Like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">B</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// some logic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">C</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// some logic 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">A</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">score</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// process the parameters a and b -&gt; a1, b1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">result1</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">B</span><span class="p">(</span><span class="nx">a1</span><span class="p">,</span> <span class="nx">b1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// process result -&gt; a2, b2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">result2</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">C</span><span class="p">(</span><span class="nx">a2</span><span class="p">,</span> <span class="nx">b2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// process the result1 and result2 to got the score
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">score</span><span class="p">,</span> <span class="kc">nil</span>    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In the example above, I have a function A, in A, it will do some very complex logic to process the parameters <code>a</code> and <code>b</code> to get a <code>score</code>.<br>
I don&rsquo;t want to care the function B and C due to I have writern unit cases for them and ensure them are run as my expect.<br>
We can use a libaray <a href="https://github.com/agiledragon/gomonkey">gomonkey</a> to mock the function.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;testing&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/agiledragon/gomonkey/v2&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestA</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span> <span class="o">:=</span> <span class="nx">assert</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mockFunc1</span> <span class="o">:=</span> <span class="nx">gomonkey</span><span class="p">.</span><span class="nf">ApplyFunc</span><span class="p">(</span><span class="nx">B</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mockFunc2</span> <span class="o">:=</span> <span class="nx">gomonkey</span><span class="p">.</span><span class="nf">ApplyFunc</span><span class="p">(</span><span class="nx">C</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">mockFunc1</span><span class="p">.</span><span class="nf">Reset</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">mockFunc2</span><span class="p">.</span><span class="nf">Reset</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// mocke data then check
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">output</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">A</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">expectData</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can mock function B and C, and output the data what we want.<br>
And the calls in A will not call the real function B and C.</p>
<h3 id="using-gomonkey-to-mock-function-of-a-struct">using gomonkey to mock function of a struct<a hidden class="anchor" aria-hidden="true" href="#using-gomonkey-to-mock-function-of-a-struct">#</a></h3>
<p>We can use <a href="https://github.com/agiledragon/gomonkey">gomonkey</a> to mock the function of a struct, including <code>public</code> and <code>private</code></p>
<ul>
<li>public function</li>
</ul>
<p>Here is the example:</p>
<p><code>appserver.go</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">AppServer</span> <span class="kd">struct</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span><span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">AppServer</span><span class="p">)</span> <span class="nf">A</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// do some logic -&gt; a1, b1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">tempResult</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">b</span><span class="p">(</span><span class="nx">a1</span><span class="p">,</span> <span class="nx">b1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// process the tempResult 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// logic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">result</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">AppServer</span><span class="p">)</span> <span class="nf">b</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// do some logic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">appServer</span> <span class="p">=</span> <span class="nx">AppServer</span><span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>AppServer</code> has 2 functions: <code>A</code> and <code>b</code>, <code>A</code> is a public function, we can call this function from outer of <code>AppServer</code>, but <code>b</code> is a private function, only call it inner <code>AppServer</code>.</p>
<p><code>apiserver.go</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Process</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">score</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// process a and b -&gt; a1, b1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">appServer</span><span class="p">.</span><span class="nf">A</span><span class="p">(</span><span class="nx">a1</span><span class="p">,</span> <span class="nx">b1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> 
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// process result -&gt; score
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">score</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Function <code>Process</code> calls public function <code>A</code> of the struct <code>AppServer</code>, how we test <code>Process</code> by mocking function <code>A</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;reflect&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;testing&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/agiledragon/gomonkey/v2&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestProcess</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">assert</span> <span class="p">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">mockFunc</span> <span class="o">:=</span> <span class="nx">gomonkey</span><span class="p">.</span><span class="nf">ApplyMethod</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">appServer</span><span class="p">),</span> <span class="s">&#34;A&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kd">func</span><span class="p">(</span><span class="nx">_</span> <span class="o">*</span><span class="nx">AppServer</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// mock result
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="nx">result</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">mockFunc</span><span class="p">.</span><span class="nf">Reset</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// mock a, b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">output</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">Process</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">expect</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>private function</li>
</ul>
<p>If we want to test the function <code>A</code> of <code>AppServer</code>, we can mock the private function <code>b</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;reflect&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;testing&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/agiledragon/gomonkey/v2&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">testAppServer</span> <span class="p">=</span> <span class="nx">AppServer</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestProcess</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">assert</span> <span class="p">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">mockFunc</span> <span class="o">:=</span> <span class="nx">gomonkey</span><span class="p">.</span><span class="nf">ApplyPrivateMethod</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">testAppServer</span><span class="p">),</span> <span class="s">&#34;b&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kd">func</span><span class="p">(</span><span class="nx">_</span> <span class="o">*</span><span class="nx">AppServer</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">result</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// mock result
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">return</span> <span class="nx">result</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">mockFunc</span><span class="p">.</span><span class="nf">Reset</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// mock a, b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">output</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">testAppServer</span><span class="p">.</span><span class="nf">A</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">expect</span><span class="p">,</span> <span class="nx">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="how-to-simulate-request-parameters">How to simulate request parameters?<a hidden class="anchor" aria-hidden="true" href="#how-to-simulate-request-parameters">#</a></h2>
<p>And I will show the full unit test cases of a webserver bases on gin:</p>
<p><code>apiserver.go</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;github.com/gin-gonic/gin&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">ApiServer</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">ApiServer</span><span class="p">)</span> <span class="nf">Query</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">    <span class="nx">userName</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Param</span><span class="p">(</span><span class="s">&#34;userName&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">userInfo</span> <span class="p">=</span> <span class="nx">UserInfo</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">userInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">appServer</span><span class="p">.</span><span class="nf">Query</span><span class="p">(</span><span class="nx">userName</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&#34;error&#34;:&#34;User not found&#34;}`</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">userInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">ApiServer</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">userInfo</span> <span class="nx">UserInfo</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ShouldBindJSON</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">userInfo</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&#34;error&#34;:&#34;Invalid request body&#34;}`</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">appServer</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">userInfo</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&#34;error&#34;:&#34;Failed to create user&#34;}`</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">ApiServer</span><span class="p">)</span> <span class="nf">QueryUserList</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">req</span> <span class="p">=</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">PageSize</span> <span class="kt">int</span> <span class="s">`form:&#34;pageSize&#34; binding:&#34;required&#34;`</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Page</span>     <span class="kt">int</span> <span class="s">`form:&#34;page&#34; binding:&#34;required&#34; `</span>
</span></span><span class="line"><span class="cl">    <span class="p">}{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">ShouldBind</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">req</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&#34;error&#34;:&#34;Invalid url value&#34;}`</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">usersInfo</span> <span class="p">[]</span><span class="nx">UserInfo</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">usersInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">appServer</span><span class="p">.</span><span class="nf">QueryList</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Page</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">PageSize</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&#34;error&#34;:&#34;Failed to query users&#34;}`</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">.</span><span class="nf">JSON</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">usersInfo</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>appserver.go</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">UserInfo</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ID</span>    <span class="kt">string</span> <span class="s">`json:&#34;id&#34;`</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Name</span>  <span class="kt">string</span> <span class="s">`json:&#34;name&#34; binding:&#34;required&#34;`</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Age</span>   <span class="kt">int</span>    <span class="s">`json:&#34;age&#34; binding:&#34;required&#34;`</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Email</span> <span class="kt">string</span> <span class="s">`json:&#34;email&#34; binding:&#34;required&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">AppServer</span> <span class="kd">struct</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">AppServer</span><span class="p">)</span> <span class="nf">Query</span><span class="p">(</span><span class="nx">userName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">userInfo</span> <span class="nx">UserInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// do a database query operation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">AppServer</span><span class="p">)</span> <span class="nf">Create</span><span class="p">(</span><span class="nx">userInfo</span> <span class="nx">UserInfo</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// do a database create operation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">AppServer</span><span class="p">)</span> <span class="nf">QueryList</span><span class="p">(</span><span class="nx">page</span><span class="p">,</span> <span class="nx">size</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">usersInfo</span> <span class="p">[]</span><span class="nx">UserInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// do a database query operation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">appServer</span> <span class="p">=</span> <span class="nx">AppServer</span><span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We assume all the function of <code>AppServer</code> have been tested passed, which means we only need to write the unit test cases for <code>ApiServer</code>.</p>
<p>We need to create a universal request function to simulate a real request.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;io&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;net/url&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;net/http/httptest&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="nx">function</span> <span class="kd">func</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">),</span> <span class="nx">reqBody</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">urlParams</span> <span class="p">[]</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Param</span><span class="p">,</span> <span class="nx">urlValues</span> <span class="nx">url</span><span class="p">.</span><span class="nx">Values</span><span class="p">)</span> <span class="p">(</span><span class="nx">resBody</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">statusCode</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">w</span> <span class="o">:=</span> <span class="nx">httptest</span><span class="p">.</span><span class="nf">NewRecorder</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">gin</span><span class="p">.</span><span class="nf">CreateTestContext</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">{</span><span class="nx">Header</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">Header</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// set reqBody
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">NopCloser</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nf">Newbuffer</span><span class="p">(</span><span class="nx">reqBody</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// set url value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawQuery</span> <span class="p">=</span> <span class="nx">urlValues</span><span class="p">.</span><span class="nf">Encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// set urlParams
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">param</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">urlParams</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nx">Params</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Params</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">body</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">ReadAll</span><span class="p">(</span><span class="nx">w</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">w</span><span class="p">.</span><span class="nx">Code</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We noticed that <code>Gin.Context</code> used <code>c.Params = append(c.Params, param)</code> to create the url parameters.</p>
<ul>
<li>url parameters
To simulate the url parameters, we can use <code>urlParams := []gin.Param{{Key: &quot;userName&quot;, Value: &quot;&quot;}}</code>.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestQuery</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">assert</span> <span class="p">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mockFuncQuery</span> <span class="o">:=</span> <span class="nx">gomonkey</span><span class="p">.</span><span class="nf">ApplyMethod</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">appServer</span><span class="p">),</span> <span class="s">&#34;Query&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kd">func</span><span class="p">(</span><span class="nx">_</span> <span class="o">*</span><span class="nx">AppServer</span><span class="p">,</span> <span class="nx">userName</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">userInfo</span> <span class="nx">UserInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">userName</span> <span class="o">==</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">UserInfo</span><span class="p">{},</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;not Found&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">userInfo</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="nx">userName</span><span class="p">},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">mockFuncQuery</span><span class="p">.</span><span class="nf">Reset</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">urlParams</span> <span class="p">[]</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Param</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">body</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">statusCode</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 404
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">urlParams</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Param</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;userName&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;&#34;</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">body</span><span class="p">,</span> <span class="nx">statusCode</span> <span class="p">=</span> <span class="nf">request</span><span class="p">(</span><span class="nx">testApiServer</span><span class="p">.</span><span class="nx">Query</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">urlParams</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`&#34;error&#34;:&#34;User not found&#34;`</span><span class="p">),</span> <span class="nx">body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 200
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">urlParams</span> <span class="p">=</span> <span class="p">[]</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Param</span><span class="p">{{</span><span class="nx">Key</span><span class="p">:</span> <span class="s">&#34;userName&#34;</span><span class="p">,</span> <span class="nx">Value</span><span class="p">:</span> <span class="s">&#34;Jack&#34;</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">body</span><span class="p">,</span> <span class="nx">statusCode</span> <span class="p">=</span> <span class="nf">request</span><span class="p">(</span><span class="nx">testApiServer</span><span class="p">.</span><span class="nx">Query</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">urlParams</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">output</span> <span class="o">:=</span> <span class="nx">UserInfo</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="nx">UserInfo</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Jack&#34;</span><span class="p">},</span> <span class="nx">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>request body</li>
</ul>
<p>The request body is always json string, so we only create a bytes data to simulate it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestCreate</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">assert</span> <span class="p">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">internalError</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mockFuncQuery</span> <span class="o">:=</span> <span class="nx">gomonkey</span><span class="p">.</span><span class="nf">ApplyMethod</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">appServer</span><span class="p">),</span> <span class="s">&#34;Create&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kd">func</span><span class="p">(</span><span class="nx">_</span> <span class="o">*</span><span class="nx">AppServer</span><span class="p">,</span> <span class="nx">userInfo</span> <span class="nx">UserInfo</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">internalError</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;internalError&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">mockFuncQuery</span><span class="p">.</span><span class="nf">Reset</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">reqBody</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">body</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">statusCode</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 400 invalid req body, Name, age and email are must keys.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// age type error 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">reqBody</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&#34;name&#34;:&#34;Jack&#34;,&#34;Age&#34;:&#34;12&#34;,&#34;Email&#34;:&#34;jack@google.com&#34;}`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">body</span><span class="p">,</span> <span class="nx">statusCode</span> <span class="p">=</span> <span class="nf">request</span><span class="p">(</span><span class="nx">testApiServer</span><span class="p">.</span><span class="nx">Create</span><span class="p">,</span> <span class="nx">reqBody</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`&#34;error&#34;:&#34;Invalid request body&#34;`</span><span class="p">),</span> <span class="nx">body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// no email field
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">reqBody</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&#34;name&#34;:&#34;Jack&#34;,&#34;Age&#34;:12}`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">body</span><span class="p">,</span> <span class="nx">statusCode</span> <span class="p">=</span> <span class="nf">request</span><span class="p">(</span><span class="nx">testApiServer</span><span class="p">.</span><span class="nx">Create</span><span class="p">,</span> <span class="nx">reqBody</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`&#34;error&#34;:&#34;Invalid request body&#34;`</span><span class="p">),</span> <span class="nx">body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// name is empty
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">reqBody</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&#34;name&#34;:&#34;&#34;,&#34;Age&#34;:12,&#34;Email&#34;:&#34;jack@google.com&#34;}`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">body</span><span class="p">,</span> <span class="nx">statusCode</span> <span class="p">=</span> <span class="nf">request</span><span class="p">(</span><span class="nx">testApiServer</span><span class="p">.</span><span class="nx">Create</span><span class="p">,</span> <span class="nx">reqBody</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`&#34;error&#34;:&#34;Invalid request body&#34;`</span><span class="p">),</span> <span class="nx">body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// internalError
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">internalError</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="nx">reqBody</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&#34;name&#34;:&#34;Jack&#34;,&#34;Age&#34;:12,&#34;Email&#34;:&#34;jack@google.com&#34;}`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">body</span><span class="p">,</span> <span class="nx">statusCode</span> <span class="p">=</span> <span class="nf">request</span><span class="p">(</span><span class="nx">testApiServer</span><span class="p">.</span><span class="nx">Create</span><span class="p">,</span> <span class="nx">reqBody</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`&#34;error&#34;:&#34;Failed to create user&#34;`</span><span class="p">),</span> <span class="nx">body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// success -&gt; 204
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">internalError</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="nx">reqBody</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&#34;name&#34;:&#34;Jack&#34;,&#34;Age&#34;:12,&#34;Email&#34;:&#34;jack@google.com&#34;}`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span><span class="p">,</span> <span class="nx">statusCode</span> <span class="p">=</span> <span class="nf">request</span><span class="p">(</span><span class="nx">testApiServer</span><span class="p">.</span><span class="nx">Create</span><span class="p">,</span> <span class="nx">reqBody</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>url value
Let&rsquo;s simulate the url value, the format of url value should be like <code>http://ip:port?page=1&amp;pageSize=10</code>, and the <code>page</code> and <code>pageSize</code> are url values.
Here I can use <code>url.Values</code>, and the it provides function <code>Add</code> to add our url valus.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-golang" data-lang="golang"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">TestQueryUserList</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">assert</span> <span class="p">=</span> <span class="nx">assert</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mockFuncQuery</span> <span class="o">:=</span> <span class="nx">gomonkey</span><span class="p">.</span><span class="nf">ApplyMethod</span><span class="p">(</span><span class="nx">reflect</span><span class="p">.</span><span class="nf">TypeOf</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">appServer</span><span class="p">),</span> <span class="s">&#34;QueryList&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kd">func</span><span class="p">(</span><span class="nx">_</span> <span class="o">*</span><span class="nx">AppServer</span><span class="p">,</span> <span class="nx">page</span><span class="p">,</span> <span class="nx">size</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">usersInfo</span> <span class="p">[]</span><span class="nx">UserInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">page</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">size</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;internalError&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">[]</span><span class="nx">UserInfo</span><span class="p">{{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Jack&#34;</span><span class="p">}},</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">mockFuncQuery</span><span class="p">.</span><span class="nf">Reset</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">body</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">statusCode</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">urlValues</span> <span class="p">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">Values</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// no page and no pageSize
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">body</span><span class="p">,</span> <span class="nx">statusCode</span> <span class="p">=</span> <span class="nf">request</span><span class="p">(</span><span class="nx">testApiServer</span><span class="p">.</span><span class="nx">QueryUserList</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">urlValues</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&#34;error&#34;:&#34;Invalid url value&#34;}`</span><span class="p">),</span> <span class="nx">body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// page &lt; 0 || pageSize &lt; 0 -&gt; internal error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">urlValues</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;page&#34;</span><span class="p">,</span> <span class="s">&#34;-1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">urlValues</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;pageSize&#34;</span><span class="p">,</span> <span class="s">&#34;-1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">body</span><span class="p">,</span> <span class="nx">statusCode</span> <span class="p">=</span> <span class="nf">request</span><span class="p">(</span><span class="nx">testApiServer</span><span class="p">.</span><span class="nx">QueryUserList</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">urlValues</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="s">`{&#34;error&#34;:&#34;Failed to query users&#34;}`</span><span class="p">),</span> <span class="nx">body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// normal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">urlValues</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;page&#34;</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">urlValues</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="s">&#34;pageSize&#34;</span><span class="p">,</span> <span class="s">&#34;10&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">body</span><span class="p">,</span> <span class="nx">statusCode</span> <span class="p">=</span> <span class="nf">request</span><span class="p">(</span><span class="nx">testApiServer</span><span class="p">.</span><span class="nx">QueryUserList</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">urlValues</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">Equal</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">statusCode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">output</span> <span class="p">[]</span><span class="nx">UserInfo</span>
</span></span><span class="line"><span class="cl">    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">Unmarshal</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">NoError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">assert</span><span class="p">.</span><span class="nf">ElementsMatch</span><span class="p">([]</span><span class="nx">UserInfo</span><span class="p">{{</span><span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;Jack&#34;</span><span class="p">}},</span> <span class="nx">output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://wuqiangroy.github.io/tags/test/">test</a></li>
      <li><a href="http://wuqiangroy.github.io/tags/golang/">golang</a></li>
      <li><a href="http://wuqiangroy.github.io/tags/gin/">gin</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="http://wuqiangroy.github.io/post/2023/travel_to_shaohai_park_in_cny/">
    <span class="title">Next »</span>
    <br>
    <span>Travel to ShaoHai Park in CNY</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="http://wuqiangroy.github.io/">Roy&#39;s Records</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
